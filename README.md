
# MiniMind Notes ğŸ“

<div align="center">

![logo](./images/logo.png)

[![GitHub Repo stars](https://img.shields.io/github/stars/llm-chaser/minimind-notes?style=social)](https://github.com/MLNLP-World/minimind-notes/stargazers)  
[![GitHub pull request](https://img.shields.io/badge/PRs-welcome-blue)](https://github.com/MLNLP-World/minimind-notes/pulls)  
[![License](https://img.shields.io/github/license/MLNLP-World/minimind-notes)](LICENSE)

</div>

<div align="center">

[é¡¹ç›®åŠ¨æœº](#é¡¹ç›®åŠ¨æœº) / [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹) / [é¡¹ç›®èµ„æº](#é¡¹ç›®èµ„æº) / [æ³¨é‡Šé£æ ¼ä¸ç¤ºä¾‹](#æ³¨é‡Šé£æ ¼ä¸ç¤ºä¾‹) / [åŸä¹¦readme](#åŸä¹¦readme) / [è´¡çŒ®æŒ‡å—](#è´¡çŒ®æŒ‡å—) / [è‡´è°¢](#è‡´è°¢)

</div>

---

<h2 id="é¡¹ç›®åŠ¨æœº">ğŸ¯ é¡¹ç›®åŠ¨æœº</h2>

åŸé¡¹ç›®ä¸åœ°å€ï¼š[MiniMind](https://github.com/jingyaogong/minimind)  

æœ¬é¡¹ç›®æ˜¯å¯¹ GitHub é¡¹ç›® **ã€ŠMiniMindã€‹** çš„ **æ³¨é‡Šå¢å¼ºç‰ˆ**ã€‚åœ¨åŸå§‹ä»£ç çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬è¡¥å……äº†é€æ–‡ä»¶ã€é€æ¨¡å—çš„è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼Œå¸®åŠ©è¯»è€…æ›´å¥½åœ°ç†è§£å¤§æ¨¡å‹çš„è®­ç»ƒæµç¨‹ã€‚  

åœ¨æ•´ç†è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°½å¯èƒ½ä¿æŒåŸå§‹å®ç°çš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§ï¼ŒåŒæ—¶åœ¨æ³¨é‡Šä¸Šè¿›è¡Œäº†é€‚åº¦ä¼˜åŒ–ï¼Œä»¥æ›´è´´åˆä¸­æ–‡å­¦ä¹ è€…çš„é˜…è¯»ä¹ æƒ¯ã€‚éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œ**åŸä½œè€…æ‰æ˜¯è¯¥é¡¹ç›®çš„ä¸»è¦è´¡çŒ®è€…**ï¼Œæœ¬ä»“åº“ä»…ä½œä¸ºå­¦ä¹ è¾…åŠ©èµ„æ–™ï¼Œä¸å¯¹åŸå†…å®¹è¿›è¡Œä¿®æ”¹æˆ–æ‰©å±•ã€‚  

ç”±äºä¸ªäººèƒ½åŠ›æœ‰é™ï¼Œæ³¨é‡Šä¸­éš¾å…å­˜åœ¨ä¸å®Œå–„ä¹‹å¤„ï¼Œæ¬¢è¿å¤§å®¶æå‡ºå®è´µæ„è§ã€‚å¸Œæœ›é€šè¿‡è¿™ä¸€é¡¹ç›®ï¼Œæ›´å¤šå­¦ä¹ è€…èƒ½å¤Ÿå¿«é€Ÿä»â€œèƒ½è·‘èµ·æ¥â€è¿‡æ¸¡åˆ°â€œèƒ½ç†è§£ã€èƒ½ä¿®æ”¹â€ï¼Œä¹Ÿå¸Œæœ›ä¸ºå›½å†…ç¤¾åŒºçš„å¤§æ¨¡å‹å­¦ä¹ ä¸ç ”ç©¶è´¡çŒ®ä¸€ä»½åŠ›é‡ã€‚    

---


<h2 id="é¡¹ç›®ç®€ä»‹">ğŸ“š é¡¹ç›®ç®€ä»‹</h2>

å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰å·²ç»æˆä¸ºå½“å‰äººå·¥æ™ºèƒ½å‘å±•çš„æ ¸å¿ƒé©±åŠ¨åŠ›ï¼Œä½†å¯¹å¤§å¤šæ•°å­¦ä¹ è€…æ¥è¯´ï¼Œ**ä»é›¶å¼€å§‹ç†è§£å¹¶å®ç°ä¸€ä¸ª LLM çš„è®­ç»ƒæµç¨‹ä»ç„¶å……æ»¡æŒ‘æˆ˜**ã€‚  

åŸå§‹çš„ [MiniMind](https://github.com/jingyaogong/minimind) é¡¹ç›®æä¾›äº†ä¸€ä¸ªæè½»é‡çš„å…¨æµç¨‹å®ç°ï¼š  
- ä»…éœ€ä½æˆæœ¬ GPUï¼Œå°±èƒ½åœ¨ 2 å°æ—¶å†…è®­ç»ƒä¸€ä¸ª 26M å‚æ•°çš„ GPT æ¨¡å‹ï¼›  
- è¦†ç›–äº†ä» *Tokenizer â†’ Pretrain â†’ SFT â†’ LoRA â†’ DPO â†’ è’¸é¦* çš„å®Œæ•´é“¾è·¯ã€‚  

åœ¨æ­¤åŸºç¡€ä¸Šï¼Œ**MiniMind-Notes** çš„å®šä½æ˜¯ï¼šåœ¨åŸé¡¹ç›®çš„å®ç°åŸºç¡€ä¸Šï¼Œè¡¥å……é€æ–‡ä»¶ã€é€æ¨¡å—çš„è¯¦å°½æ³¨é‡Šï¼Œå¸®åŠ©å­¦ä¹ è€…é™ä½ç†è§£é—¨æ§›ï¼Œä»è€Œæ›´å¿«æŒæ¡è®­ç»ƒæµç¨‹ä¸å®ç°åŸç†ã€‚  

### âœ¨ æœ¬é¡¹ç›®çš„ç‰¹è‰²
- æ¯ä¸ªæºç æ–‡ä»¶åŒ…å«ç”¨é€”è¯´æ˜ã€æ ¸å¿ƒåŸç†ä¸ç‰¹ç‚¹æ€»ç»“ï¼›  
- å‡½æ•°é…å¤‡æ¸…æ™°çš„ docstring ä¸è¡Œå†…æ³¨é‡Šï¼›  
- æ³¨é‡Šå‡ä¸ºä¸­æ–‡ç¼–å†™ï¼Œé€‚åˆåˆå­¦è€…å¿«é€Ÿä¸Šæ‰‹ï¼›  
- ä¸åŸä»“åº“ä¿æŒåŒæ­¥æ›´æ–°ï¼Œä¿è¯å¯å¤ç°æ€§ã€‚  

### ğŸ’¡ é€šè¿‡æœ¬é¡¹ç›®ï¼Œä½ å°†èƒ½å¤Ÿ
- ç†è§£ä»é›¶å®ç°ä¸€ä¸ª GPT é£æ ¼ LLM çš„å®Œæ•´æµç¨‹ï¼›  
- æŒæ¡é¢„è®­ç»ƒ (Pretrain)ã€ç›‘ç£å¾®è°ƒ (SFT)ã€LoRAã€DPO ç­‰æ ¸å¿ƒç¯èŠ‚ï¼›  
- å­¦ä¼šå¦‚ä½•å‡†å¤‡æ•°æ®é›†ã€è¿è¡Œè®­ç»ƒã€è¯„ä¼°æ¨¡å‹ï¼›  
- æå‡æºç é˜…è¯»ä¸ç†è§£èƒ½åŠ›ï¼Œä¸ºåç»­ç ”ç©¶ä¸æ”¹è¿›æ‰“ä¸‹åŸºç¡€ã€‚  

---

<h2 id="é¡¹ç›®èµ„æº">ğŸ“– é¡¹ç›®èµ„æº</h2>

- åŸç‰ˆé¡¹ç›®åœ°å€ï¼š[MiniMind](https://github.com/jingyaogong/minimind)  
- æ³¨é‡Šå¢å¼ºç‰ˆï¼š[MiniMind-Notes](https://github.com/MLNLP-World/minimind-notes)  
- æ•°æ®é›†ä¸‹è½½ï¼š
  - [MiniMind Dataset @ HuggingFace](https://huggingface.co/datasets/jingyaogong/minimind_dataset/tree/main)  
  - [MiniMind Dataset @ ModelScope](https://www.modelscope.cn/datasets/gongjy/minimind_dataset/files)  
- æ¨¡å‹ä¸‹è½½ï¼š[MiniMind2](https://huggingface.co/jingyaogong/MiniMind2)  

å¿«é€Ÿä½“éªŒï¼š
```bash
git clone https://github.com/MLNLP-World/minimind-notes.git

````


---

<h2 id="æ³¨é‡Šé£æ ¼ä¸ç¤ºä¾‹">ğŸ“– æ³¨é‡Šé£æ ¼ä¸ç¤ºä¾‹</h2>


### ğŸ–Šï¸ æ³¨é‡Šé£æ ¼
ä»£ç é‡‡ç”¨ **æ–‡ä»¶çº§ä¸‰æ®µå¼è¯´æ˜ + å‡½æ•° docstring + å…³é”®è¡Œå†…æ³¨é‡Š**ï¼Œä¸‰è€…ç»“åˆï¼Œä¿è¯æ—¢èƒ½å®è§‚ç†è§£æ¨¡å—ä½œç”¨ï¼Œåˆèƒ½åœ¨ç»†èŠ‚å¤„å¿«é€Ÿä¸Šæ‰‹ã€‚

### ğŸ“ ç¤ºä¾‹
ä»¥ä¸‹ä¸ºå®Œæ•´ç¤ºä¾‹ï¼Œåˆ†åˆ«å±•ç¤ºä¸‰ç§æ³¨é‡Šå½¢å¼ï¼š
```python
# ===== 1) æ–‡ä»¶çº§ä¸‰æ®µå¼è¯´æ˜ =====
æ–‡ä»¶ç”¨é€”ï¼š
  ä½¿ç”¨ Direct Preference Optimization (DPO) å¯¹ MiniMind è¿›è¡Œåå¥½å¯¹é½è®­ç»ƒã€‚

æ ¸å¿ƒåŸç†ï¼š
  - æ— éœ€ RL ä¸­çš„å¥–åŠ±æ¨¡å‹ï¼ˆRMï¼‰å’Œ PPO å¤æ‚æµç¨‹ï¼Œç›´æ¥é€šè¿‡æˆå¯¹åå¥½æ•°æ®ï¼ˆchosen/rejectedï¼‰ä¼˜åŒ–æ¨¡å‹ã€‚
  - æ ¸å¿ƒæ€æƒ³ï¼šè®©æ¨¡å‹å¯¹â€œäººç±»åå¥½çš„å›ç­”ï¼ˆchosenï¼‰â€è¾“å‡ºæ¦‚ç‡é«˜äºâ€œä¸åå¥½çš„å›ç­”ï¼ˆrejectedï¼‰â€ï¼Œä»¥å‚è€ƒæ¨¡å‹ï¼ˆref_modelï¼‰ä¸ºåŸºå‡†ã€‚

ç‰¹ç‚¹ï¼š
  - å‚è€ƒæ¨¡å‹ ref_model å›ºå®šä¸è®­ç»ƒï¼›è¢«è®­ç»ƒæ¨¡å‹ä¸å…¶å¯¹æ¯” log æ¦‚ç‡æ¯”
  - æ”¯æŒ AMP æ··åˆç²¾åº¦ã€DDP åˆ†å¸ƒå¼ã€ä½™å¼¦é€€ç«å­¦ä¹ ç‡
  - æ•°æ®é›†ä¸ºæˆå¯¹æ ·æœ¬ï¼ˆchosen / rejectedï¼‰ï¼Œç”± DPODataset æä¾›
  - ä»…å¯¹ assistant å›å¤åŒºåŸŸè®¡å…¥æŸå¤±ï¼ˆç”± mask æ§åˆ¶ï¼‰
```
```python
# ===== 2) å‡½æ•° docstring ç¤ºä¾‹ =====
class MOEFeedForward(nn.Module):
    """
    MoE ç‰ˆæœ¬çš„å‰é¦ˆç½‘ç»œ (FFN)ï¼š
      - è®­ç»ƒï¼šæŒ‰ top-k å°† token åˆ†é…ç»™ä¸“å®¶å¹¶åŠ æƒåˆå¹¶
      - æ¨ç†ï¼šæŒ‰ä¸“å®¶åˆ†ç»„æ‰¹é‡å‰å‘ï¼ˆmoe_inferï¼Œæ— æ¢¯åº¦ï¼‰
      - å¯é€‰ shared_expertsï¼šå¯¹æ®‹å·®è¿›è¡Œé¢å¤–çš„å…±äº«ä¸“å®¶ä¿®æ­£
    """
```

```python
# ===== 3) å…³é”®è¡Œå†…æ³¨é‡Šç¤ºä¾‹ =====
    def forward(self, x):
        identity = x
        orig_shape = x.shape
        bsz, seq_len, _ = x.shape
        # 1) é—¨æ§é€‰æ‹©ä¸“å®¶
        topk_idx, topk_weight, aux_loss = self.gate(x)
        # 2) è®­ç»ƒ/æ¨ç†ä¸¤æ¡è·¯å¾„
        x = x.view(-1, x.shape[-1])          # [bs*seq, hidden]
        flat_topk_idx = topk_idx.view(-1)    # [bs*seq*topk]
        if self.training:
            # è®­ç»ƒï¼šå¤åˆ¶ tokenï¼ŒæŒ‰ä¸“å®¶æ©ç åˆ†åˆ«å‰å‘ï¼Œå†æŒ‰æƒé‡èšåˆ
            x = x.repeat_interleave(self.config.num_experts_per_tok, dim=0)
            y = torch.empty_like(x, dtype=torch.float16)  # ç¼“å­˜å„ä¸“å®¶è¾“å‡ºï¼ˆèŠ‚çœæ˜¾å­˜ï¼‰
            for i, expert in enumerate(self.experts):
                y[flat_topk_idx == i] = expert(x[flat_topk_idx == i]).to(y.dtype)
            # æŒ‰ topk æƒé‡åŠ æƒèåˆ
            y = (y.view(*topk_weight.shape, -1) * topk_weight.unsqueeze(-1)).sum(dim=1)
            y = y.view(*orig_shape)
        else:
            # æ¨ç†ï¼šæ— æ¢¯åº¦ + åˆ†ç»„æ‰¹é‡å‰å‘ï¼Œå‡å°‘å°æ‰¹æ¬¡ kernel å¯åŠ¨å¼€é”€
            y = self.moe_infer(x, flat_topk_idx, topk_weight.view(-1, 1)).view(*orig_shape)
        # 3) å…±äº«ä¸“å®¶ï¼ˆæ®‹å·®ä¿®æ­£ï¼‰
        if self.config.n_shared_experts > 0:
            for expert in self.shared_experts:
                y = y + expert(identity)
        # æš´éœ² aux_lossï¼Œä¾›ä¸Šå±‚æ±‡æ€»
        self.aux_loss = aux_loss
        return y
```

---

<h2 id="åŸä¹¦readme">ğŸ“œ åŸä¹¦readme</h2>

ä»¥ä¸‹ä¸º [MiniMind å®˜æ–¹é¡¹ç›®](https://github.com/jingyaogong/minimind) çš„æ ¸å¿ƒå†…å®¹ï¼š

> æ­¤å¼€æºé¡¹ç›®æ—¨åœ¨å®Œå…¨ä»0å¼€å§‹ï¼Œä»…ç”¨ **3å—é’±æˆæœ¬ + 2å°æ—¶**ï¼Œå³å¯è®­ç»ƒå‡ºä»… 25.8M çš„è¶…å°è¯­è¨€æ¨¡å‹ MiniMindã€‚
> MiniMind ç³»åˆ—æå…¶è½»é‡ï¼Œæœ€å°ç‰ˆæœ¬ä½“ç§¯æ˜¯ GPT-3 çš„ 1/7000ï¼ŒåŠ›æ±‚åšåˆ°æœ€æ™®é€šçš„ä¸ªäºº GPU ä¹Ÿå¯å¿«é€Ÿè®­ç»ƒã€‚
> é¡¹ç›®åŒæ—¶å¼€æºäº†ä» **Tokenizer â†’ Pretrain â†’ SFT â†’ LoRA â†’ DPO â†’ è’¸é¦** çš„å…¨è¿‡ç¨‹ä»£ç ã€‚

### ğŸ”§ å¿«é€Ÿå¼€å§‹

```bash
git clone https://github.com/jingyaogong/minimind.git
cd minimind
pip install -r requirements.txt
```

ä¸‹è½½æ¨¡å‹ï¼š

```bash
git clone https://huggingface.co/jingyaogong/MiniMind2
```

é¢„è®­ç»ƒï¼š

```bash
python trainer/train_pretrain.py
```

ç›‘ç£å¾®è°ƒï¼š

```bash
python trainer/train_full_sft.py
```

è¯„ä¼°ï¼š

```bash
python eval_model.py --model_mode 1
```

### ğŸ“‚ æ•°æ®é›†ç¤ºä¾‹

æ¨èæœ€å°ç»„åˆï¼š

* `pretrain_hq.jsonl`
* `sft_mini_512.jsonl`

æ›´å¤šæ•°æ®é›†è¯¦è§ï¼š[MiniMind Dataset](https://huggingface.co/datasets/jingyaogong/minimind_dataset/tree/main)ã€‚

---

<h2 id="è´¡çŒ®æŒ‡å—">ğŸ¤ è´¡çŒ®æŒ‡å—</h2>

* æ¬¢è¿æäº¤ **æ›´è¯¦ç»†çš„æ³¨é‡Š**ã€**å­¦ä¹ ç¬”è®°** æˆ– **æ”¹è¿›å»ºè®®**ã€‚
* æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©è¿™ä¸ªé¡¹ç›®æˆä¸º **LLM å­¦ä¹ å…¥é—¨çš„å‚è€ƒæ‰‹å†Œ**ã€‚

---

<h2 id="è‡´è°¢">ğŸ“ è‡´è°¢</h2>

* åŸé¡¹ç›®ä½œè€…ï¼š[jingyaogong/minimind](https://github.com/jingyaogong/minimind)
* å·²å‚ä¸çš„è´¡çŒ®è€… ğŸ™Œ

<table>
  <tr>
    <td align="center">
      <a href="https://github.com/jingyaogong">
        <img src="./images/contributors/jingyaogong.jpeg" width="80" height="80" alt="jingyaogong"/><br/>
        <sub><b>jingyaogong</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://github.com/llm-chaser">
        <img src="./images/contributors/llm-chaser.jpg" width="80" height="80" alt="llm-chaser"/><br/>
        <sub><b>llm-chaser</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://github.com/jiusheng58">
        <img src="./images/contributors/jiusheng58.png" width="80" height="80" alt="jiusheng58"/><br/>
        <sub><b>jiusheng58</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://github.com/lul0308">
        <img src="./images/contributors/lul0308.png" width="80" height="80" alt="jiusheng58"/><br/>
        <sub><b>lul0308</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://github.com/qinzheng-li">
        <img src="./images/contributors/qinzheng-li.png" width="80" height="80" alt="jiusheng58"/><br/>
        <sub><b>qinzheng-li</b></sub>
      </a>
    </td>
  </tr>
</table>

---

<h2 id="license">ğŸ“œ License</h2>

æœ¬é¡¹ç›®é‡‡ç”¨ [Apache-2.0 License](LICENSE)ã€‚

